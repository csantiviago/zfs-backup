#!/bin/bash

set -euo pipefail

# Configuration
DATASET="${ZFS_DATASET:-}"
TIMESTAMP="$(date +auto-%Y-%m-%d_%H-%M)"
LOGFILE="/var/log/zfs-backup.log"

# Validate required configuration
if [ -z "${DATASET}" ]; then
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: ZFS_DATASET environment variable must be set" >&2
    echo "Usage: sudo ZFS_DATASET=\"your/dataset\" $0" >&2
    echo "Find your datasets with: zfs list" >&2
    exit 1
fi

SNAPSHOT="${DATASET}@${TIMESTAMP}"

# Logging function - logs to both stderr and log file
log() {
    local MESSAGE="[$(date '+%Y-%m-%d %H:%M:%S')] $*"
    echo "${MESSAGE}" >&2
    echo "${MESSAGE}" | sudo tee -a "${LOGFILE}" > /dev/null
}

# Check if we have sudo privileges for zfs FIRST (before any zfs commands)
if ! sudo -v &>/dev/null; then
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: sudo privileges required. Please run with sudo or ensure sudo access is configured" >&2
    exit 1
fi

# Check if dataset exists (now we know we have sudo)
if ! sudo zfs list -H -o name "${DATASET}" &>/dev/null; then
    log "ERROR: Dataset '${DATASET}' does not exist"
    exit 1
fi

# Create snapshot
log "Creating snapshot: ${SNAPSHOT}"
if sudo zfs snapshot "${SNAPSHOT}" 2>&1 | sudo tee -a "${LOGFILE}" > /dev/null; then
    log "SUCCESS: Snapshot created successfully"
    exit 0
else
    log "ERROR: Failed to create snapshot"
    exit 1
fi
